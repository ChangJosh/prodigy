<!DOCTYPE html>
<html>
<head>
    <title>Cell Explorer: Biology Quest</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Source+Code+Pro:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6c5ce7;
            --secondary: #a29bfe;
            --accent: #fd79a8;
            --dark: #2d3436;
            --light: #f5f6fa;
            --success: #00b894;
            --danger: #d63031;
            --warning: #fdcb6e;
            --info: #0984e3;
        }
        
        body {
            font-family: 'Montserrat', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #0f0f1a;
            color: var(--light);
            line-height: 1.6;
            height: 100vh;
            overflow: hidden;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(108, 92, 231, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(253, 121, 168, 0.1) 0%, transparent 20%);
        }
        
        .game-container {
            background-color: rgba(45, 52, 54, 0.9);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: fadeIn 0.5s ease-out;
            height: calc(100vh - 60px);
            width: calc(100vw - 60px);
            position: fixed;
            top: 0;
            left: 0;
            margin: 30px;
            display: flex;
            flex-direction: column;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        h1, h2, h3, h4 {
            font-weight: 700;
            margin-top: 0;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        h1 {
            font-size: 2.5rem;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 20px;
            position: relative;
            display: inline-block;
        }
        
        h1::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            border-radius: 3px;
        }
        
        button {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            color: white;
            padding: 12px 24px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 8px 4px;
            cursor: pointer;
            border-radius: 50px;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(108, 92, 231, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(108, 92, 231, 0.6);
        }
        
        button:active {
            transform: translateY(1px);
        }
        
        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: 0.5s;
        }
        
        button:hover::before {
            left: 100%;
        }
        
        button:disabled {
            background: #636e72;
            box-shadow: none;
            transform: none;
            cursor: not-allowed;
        }
        
        button:disabled::before {
            display: none;
        }
        
        .battle-log {
            height: 150px;
            overflow-y: scroll;
            border: 1px solid rgba(255,255,255,0.1);
            padding: 15px;
            margin-top: 20px;
            background-color: rgba(0,0,0,0.3);
            border-radius: 8px;
            font-family: 'Source Code Pro', monospace;
            color: #dfe6e9;
            flex-shrink: 0;
        }
        
        .stats {
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 1px solid rgba(255,255,255,0.05);
            position: relative;
            flex-shrink: 0;
        }
        
        .stats::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            border-radius: 4px 4px 0 0;
        }
        
        .question {
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 12px;
            margin: 15px 0;
            border-left: 4px solid var(--primary);
            flex-grow: 1;
            overflow-y: auto;
        }
        
        .options {
            margin: 15px 0;
        }
        
        .option {
            margin: 10px 0;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            font-weight: 500;
        }
        
        .option:hover {
            background: rgba(255,255,255,0.1);
            transform: translateX(5px);
        }
        
        .option.selected {
            border: 1px solid var(--primary);
            background: rgba(108, 92, 231, 0.2);
        }
        
        .correct {
            background: rgba(0, 184, 148, 0.2) !important;
            border: 1px solid var(--success) !important;
        }
        
        .incorrect {
            background: rgba(214, 48, 49, 0.2) !important;
            border: 1px solid var(--danger) !important;
        }
        
        .location-image {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            margin: 15px 0;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            border: 2px solid rgba(255,255,255,0.1);
            flex-shrink: 0;
        }
        
        .enemy-video {
            width: 100%;
            max-height: 200px;
            border-radius: 12px;
            margin: 15px 0;
            object-fit: cover;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
            border: 2px solid rgba(253, 121, 168, 0.3);
            flex-shrink: 0;
        }
        
        .progress-container {
            width: 100%;
            background: rgba(255,255,255,0.1);
            border-radius: 50px;
            margin: 10px 0;
            height: 10px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            border-radius: 50px;
            width: 100%;
            transition: width 0.5s ease-out;
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(108, 92, 231, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(108, 92, 231, 0); }
            100% { box-shadow: 0 0 0 0 rgba(108, 92, 231, 0); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        .shake {
            animation: shake 0.5s;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        .damage-effect {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(214, 48, 49, 0.3);
            pointer-events: none;
            opacity: 0;
            z-index: 100;
        }
        
        .heal-effect {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 184, 148, 0.3);
            pointer-events: none;
            opacity: 0;
            z-index: 100;
        }
        
        .location-card {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
            transition: all 0.3s;
            border: 1px solid transparent;
            cursor: pointer;
        }
        
        .location-card:hover {
            border: 1px solid var(--primary);
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .location-category {
            display: inline-block;
            font-size: 0.8rem;
            background: rgba(253, 121, 168, 0.2);
            color: var(--accent);
            padding: 2px 8px;
            border-radius: 50px;
            margin-right: 5px;
        }
        
        /* Overlay styles */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        
        .overlay-content {
            background-color: rgba(45, 52, 54, 0.95);
            padding: 30px;
            border-radius: 16px;
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            border: 2px solid var(--primary);
            box-shadow: 0 0 30px rgba(108, 92, 231, 0.5);
            position: relative;
        }
        
        .close-overlay {
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--danger);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .knowledge-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .knowledge-item {
            background: rgba(108, 92, 231, 0.1);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--primary);
        }
        
        .knowledge-stars {
            font-size: 1.2rem;
            color: var(--warning);
            margin-top: 5px;
        }
        
        .screen {
            display: none;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }
        
        .screen.active {
            display: flex;
        }
        
        .content-area {
            flex-grow: 1;
            overflow-y: auto;
            padding-bottom: 20px;
        }
        
        .button-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin: 10px 0;
            flex-shrink: 0;
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .game-container {
                padding: 15px;
                margin: 15px;
                height: calc(100vh - 30px);
                width: calc(100vw - 30px);
            }
            
            h1 {
                font-size: 2rem;
            }
            
            button {
                padding: 10px 20px;
                font-size: 14px;
            }
            
            .overlay-content {
                width: 90%;
                padding: 20px;
            }
            
            .knowledge-container {
                grid-template-columns: 1fr 1fr;
            }
            
            .location-image,
            .enemy-video {
                max-height: 150px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>Cell Explorer: Biology Quest</h1>
        
        <!-- Welcome Screen -->
        <div id="welcome-screen" class="screen active">
            <div class="content-area">
                <h2>Welcome to the Microscopic Frontier!</h2>
                <p>As a nanobiologist, you've been miniaturized to explore the cellular world. Deadly pathogens threaten the cell - use your biology knowledge to defeat them!</p>
                
                <video autoplay loop muted class="location-image">
                    <source src="https://assets.mixkit.co/videos/preview/mixkit-microscopic-view-of-a-virus-rotating-15645-large.mp4" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
                
                <p>Enter your scientist's name:</p>
                <input type="text" id="player-name" placeholder="Dr. Lastname" style="width: 100%; padding: 12px; font-size: 16px;">
            </div>
            <div class="button-row">
                <button onclick="startGame()" class="pulse">Begin Cellular Expedition</button>
            </div>
        </div>
        
        <!-- Main Menu Screen -->
        <div id="main-menu-screen" class="screen">
            <div class="stats" id="player-stats"></div>
            <div class="content-area">
                <h2 id="location-title"></h2>
                <p id="location-description"></p>
                
                <video autoplay loop muted class="location-image" id="location-video">
                    <source src="" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
            </div>
            <div class="button-row">
                <button onclick="explore()">Explore</button>
                <button onclick="rest()">Use Health Pack (+20 HP)</button>
                <button onclick="showLocationScreen()">Travel to New Location</button>
            </div>
            <div id="battle-log" class="battle-log"></div>
        </div>
        
        <!-- Battle Screen -->
        <div id="battle-screen" class="screen">
            <div style="display: flex; gap: 20px; margin-bottom: 15px;">
                <div class="stats" id="battle-player-stats"></div>
                <div class="stats" id="enemy-stats"></div>
            </div>
            <div class="content-area">
                <h2 id="battle-title" style="color: var(--danger);"></h2>
                
                <video autoplay loop muted class="enemy-video" id="enemy-video">
                    <source src="" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
                
                <div class="question" id="battle-question">
                    <h4 id="question-text"></h4>
                    <div class="options" id="options-container"></div>
                </div>
            </div>
            <div class="button-row">
                <button id="submit-btn" onclick="checkAnswer()" disabled>Submit Answer</button>
                <button onclick="tryFlee()" style="background: linear-gradient(135deg, #636e72, #b2bec3);">Retreat</button>
            </div>
            <div id="battle-log-2" class="battle-log"></div>
        </div>
        
        <!-- Location Screen -->
        <div id="location-screen" class="screen">
            <div class="content-area">
                <h2>Select Research Destination:</h2>
                <p>Choose a new cellular location to explore. Different locations contain different types of pathogens.</p>
                
                <div id="location-cards"></div>
            </div>
            <div class="button-row">
                <button onclick="showMainMenu()">Back to Current Location</button>
            </div>
        </div>
        
        <!-- Game Over Screen -->
        <div id="game-over-screen" class="screen">
            <div class="content-area" style="text-align: center;">
                <h2 style="color: var(--danger);">MISSION FAILED</h2>
                <p id="game-over-text"></p>
                
                <video autoplay loop muted class="location-image" style="max-height: 200px;">
                    <source src="https://assets.mixkit.co/videos/preview/mixkit-red-blood-cells-flowing-in-a-vein-15800-large.mp4" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
                
                <div style="background: rgba(214, 48, 49, 0.2); padding: 20px; border-radius: 12px; margin: 20px 0;">
                    <h3>Expedition Report</h3>
                    <p>Final Level: <strong id="final-level"></strong></p>
                    <p>Questions Answered: <strong id="questions-answered"></strong></p>
                    <p>Accuracy: <strong id="final-accuracy"></strong></p>
                </div>
                
                <p id="performance-comment" style="color: var(--success);"></p>
            </div>
            <div class="button-row">
                <button onclick="resetGame()" class="pulse">New Expedition</button>
            </div>
        </div>
    </div>
    
    <!-- Overlay for knowledge display -->
    <div id="knowledge-overlay" class="overlay" style="display: none;">
        <div class="overlay-content">
            <button class="close-overlay" onclick="closeOverlay()">√ó</button>
            <h2>Your Knowledge Base</h2>
            <p>Your expertise in different biology categories affects your damage against pathogens.</p>
            <div class="knowledge-container" id="knowledge-display"></div>
        </div>
    </div>
    
    <div id="damage-effect" class="damage-effect"></div>
    <div id="heal-effect" class="heal-effect"></div>

    <script>
        // Game data - all your biology questions
        const biologyQuestions = [
            {
                question: "Which of the following is most relevant to the Calvin cycle?",
                options: [
                    "How does chlorophyll capture light?",
                    "How is ATP used in the formation of 3-carbon carbohydrates?",
                    "How is NADP+ reduced to NADPH?",
                    "How is ATP produced in chemiosmosis?"
                ],
                answer: 1,
                category: "Photosynthesis"
            },
            {
                question: "During photosynthesis",
                options: [
                    "light reactions produce sugar, while the Calvin cycle produces O2.",
                    "light reactions produce NADPH and ATP, while the Calvin cycle produces sugar.",
                    "light reactions photo phosphorylate ADP, while the Calvin cycle produces ATP.",
                    "the Calvin cycle produces both sugar and O2."
                ],
                answer: 1,
                category: "Photosynthesis"
            },
            {
                question: "Organisms that reproduce sexually exhibit zygotic, gametic, or sporic meiosis. One way to determine the type of life cycle an organism has is by",
                options: [
                    "observing embryonic development.",
                    "comparing the diploid and haploid forms of the organism.",
                    "determining when in the life cycle fertilization occurs.",
                    "determining if gametes are multicellular or unicellular."
                ],
                answer: 1,
                category: "Reproduction"
            },
            {
                question: "If the transformation depicted in organelle B requires oxygen, what form of energy is represented by E IV?",
                options: [
                    "Radiant energy in the form of photons",
                    "Chemical energy being stored as glycogen",
                    "Chemical energy in the form of ATP",
                    "Chemical energy released by glycolysis"
                ],
                answer: 2,
                category: "Cellular Energy"
            },
            {
                question: "What is the main function of the nucleus?",
                options: [
                    "Store nutrients",
                    "Store and protect DNA",
                    "Help with digestion",
                    "Make proteins"
                ],
                answer: 1,
                category: "Cell Structure"
            },
            {
                question: "Which organelle is responsible for making proteins?",
                options: [
                    "Mitochondria",
                    "Ribosomes",
                    "Lysosomes",
                    "Golgi apparatus"
                ],
                answer: 1,
                category: "Cell Structure"
            },
            {
                question: "Where are ribosomes made?",
                options: [
                    "Nucleolus",
                    "Cytoplasm",
                    "Endoplasmic reticulum",
                    "Mitochondria"
                ],
                answer: 0,
                category: "Cell Structure"
            },
            {
                question: "What does the smooth endoplasmic reticulum (smooth ER) do?",
                options: [
                    "Make proteins",
                    "Break down waste",
                    "Make lipids and detoxify substances",
                    "Make ATP"
                ],
                answer: 2,
                category: "Cell Structure"
            },
            {
                question: "What is the function of the rough ER?",
                options: [
                    "Helps make and transport proteins",
                    "Produces glucose",
                    "Packages DNA",
                    "Stores calcium"
                ],
                answer: 0,
                category: "Cell Structure"
            },
            {
                question: "Which organelle modifies and packages proteins?",
                options: [
                    "Ribosome",
                    "Golgi apparatus",
                    "Lysosome",
                    "Nucleolus"
                ],
                answer: 1,
                category: "Cell Structure"
            },
            {
                question: "Which organelle is the 'powerhouse' of the cell?",
                options: [
                    "Nucleus",
                    "Mitochondria",
                    "Golgi apparatus",
                    "Ribosome"
                ],
                answer: 1,
                category: "Cell Structure"
            },
            {
                question: "Which organelle helps break down waste in the cell?",
                options: [
                    "Nucleus",
                    "Ribosome",
                    "Lysosome",
                    "Golgi body"
                ],
                answer: 2,
                category: "Cell Structure"
            },
            {
                question: "What is the function of the cytoskeleton?",
                options: [
                    "Gives the cell shape and helps with movement",
                    "Stores energy",
                    "Makes proteins",
                    "Destroys invaders"
                ],
                answer: 0,
                category: "Cell Structure"
            },
            {
                question: "Where are most organelles found?",
                options: [
                    "Nucleus",
                    "Cell wall",
                    "Cytoplasm",
                    "Golgi body"
                ],
                answer: 2,
                category: "Cell Structure"
            },
            {
                question: "Which structure controls what enters and leaves the cell?",
                options: [
                    "Cell wall",
                    "Cell membrane",
                    "Nucleus",
                    "Mitochondria"
                ],
                answer: 1,
                category: "Cell Structure"
            },
            {
                question: "What is a function of the vacuole in plant cells?",
                options: [
                    "Stores water and nutrients",
                    "Makes proteins",
                    "Breaks down DNA",
                    "Makes glucose"
                ],
                answer: 0,
                category: "Cell Structure"
            },
            {
                question: "Which organelle is found only in plant cells and helps with photosynthesis?",
                options: [
                    "Mitochondria",
                    "Chloroplast",
                    "Nucleus",
                    "Smooth ER"
                ],
                answer: 1,
                category: "Cell Structure"
            },
            {
                question: "What is the function of the cell wall in plant cells?",
                options: [
                    "Store water",
                    "Transport proteins",
                    "Provide structure and protection",
                    "Make proteins"
                ],
                answer: 2,
                category: "Cell Structure"
            },
            {
                question: "What type of cells have a cell wall and chloroplasts?",
                options: [
                    "Animal cells",
                    "Plant cells",
                    "Bacterial cells",
                    "Fungal cells"
                ],
                answer: 1,
                category: "Cell Types"
            },
            {
                question: "What do prokaryotic cells lack?",
                options: [
                    "A nucleus",
                    "DNA",
                    "A cell wall",
                    "A cell membrane"
                ],
                answer: 0,
                category: "Cell Types"
            },
            {
                question: "Which of the following is found in both prokaryotic and eukaryotic cells?",
                options: [
                    "Ribosomes",
                    "Nucleus",
                    "Mitochondria",
                    "Golgi apparatus"
                ],
                answer: 0,
                category: "Cell Types"
            },
            {
                question: "Which organelle is responsible for cellular respiration?",
                options: [
                    "Chloroplast",
                    "Golgi body",
                    "Mitochondria",
                    "Lysosome"
                ],
                answer: 2,
                category: "Cell Function"
            },
            {
                question: "How are proteins transported from the ER to the Golgi?",
                options: [
                    "Through cytoplasm directly",
                    "In vesicles",
                    "Through the nucleus",
                    "Using DNA"
                ],
                answer: 1,
                category: "Cell Function"
            },
            {
                question: "What does the large central vacuole in plant cells do?",
                options: [
                    "Make ATP",
                    "Store water and maintain turgor pressure",
                    "Digest food",
                    "Break down proteins"
                ],
                answer: 1,
                category: "Cell Function"
            },
            {
                question: "Which structure helps animal cells divide?",
                options: [
                    "Centrioles",
                    "Lysosomes",
                    "Ribosomes",
                    "Chloroplasts"
                ],
                answer: 0,
                category: "Cell Function"
            },
            {
                question: "Why are mitochondria important to cells?",
                options: [
                    "They store water",
                    "They produce energy (ATP)",
                    "They make proteins",
                    "They package enzymes"
                ],
                answer: 1,
                category: "Cell Function"
            },
            {
                question: "What is the jelly-like substance inside the cell called?",
                options: [
                    "DNA",
                    "Nucleoplasm",
                    "Cytoplasm",
                    "Lysosome"
                ],
                answer: 2,
                category: "Cell Structure"
            },
            {
                question: "Which organelle uses sunlight to make glucose?",
                options: [
                    "Mitochondria",
                    "Chloroplast",
                    "Ribosome",
                    "Smooth ER"
                ],
                answer: 1,
                category: "Cell Function"
            },
            {
                question: "What is the main job of ribosomes?",
                options: [
                    "Store DNA",
                    "Make energy",
                    "Make proteins",
                    "Control the cell"
                ],
                answer: 2,
                category: "Cell Function"
            },
            {
                question: "What surrounds the nucleus and lets things in and out?",
                options: [
                    "Cell wall",
                    "Nuclear envelope",
                    "Cytoplasm",
                    "Nucleolus"
                ],
                answer: 1,
                category: "Cell Structure"
            },
            {
                question: "Which organelle is involved in detoxifying harmful substances in the liver?",
                options: [
                    "Rough ER",
                    "Smooth ER",
                    "Lysosome",
                    "Mitochondria"
                ],
                answer: 1,
                category: "Cell Function"
            },
            {
                question: "What structure helps proteins fold and get ready for transport?",
                options: [
                    "Nucleus",
                    "Rough ER",
                    "Golgi body",
                    "Lysosome"
                ],
                answer: 1,
                category: "Cell Function"
            },
            {
                question: "Which part of the cell helps maintain its shape and allows for movement?",
                options: [
                    "Cytoskeleton",
                    "Cell wall",
                    "Ribosome",
                    "Vesicle"
                ],
                answer: 0,
                category: "Cell Structure"
            },
            {
                question: "What do lysosomes contain to break down waste?",
                options: [
                    "Water",
                    "Digestive enzymes",
                    "Glucose",
                    "Ribosomes"
                ],
                answer: 1,
                category: "Cell Function"
            }
        ];

        // Track which questions have been used
        const usedQuestionIndices = new Set();

        function getRandomQuestion(category) {
            // Filter questions by category and unused ones
            const availableQuestions = biologyQuestions
                .map((q, index) => ({...q, index}))
                .filter(q => 
                    (category ? q.category === category : true) && 
                    !usedQuestionIndices.has(q.index)
                );

            if (availableQuestions.length === 0) {
                // If all questions have been used, reset the used set
                usedQuestionIndices.clear();
                return getRandomQuestion(category);
            }

            const randomQuestion = availableQuestions[Math.floor(Math.random() * availableQuestions.length)];
            usedQuestionIndices.add(randomQuestion.index);
            return randomQuestion;
        }

        // Locations with their categories
        const locations = [
            { 
                name: "Cell Membrane", 
                categories: ["Cell Structure"], 
                description: "The gatekeeper of the cell, controlling what enters and exits.",
                color: "#74b9ff",
                video: "https://assets.mixkit.co/videos/preview/mixkit-cells-under-a-microscope-15828-large.mp4"
            },
            { 
                name: "Cytoplasm", 
                categories: ["Cell Structure", "Cell Function"], 
                description: "The jelly-like substance where most cellular activities occur.",
                color: "#a29bfe",
                video: "https://assets.mixkit.co/videos/preview/mixkit-cells-under-a-microscope-15828-large.mp4"
            },
            { 
                name: "Nucleus", 
                categories: ["Cell Structure"], 
                description: "The control center containing the cell's genetic material.",
                color: "#fd79a8",
                video: "https://assets.mixkit.co/videos/preview/mixkit-cells-under-a-microscope-15828-large.mp4"
            },
            { 
                name: "Mitochondria", 
                categories: ["Cell Function", "Cellular Energy"], 
                description: "The powerhouse of the cell where ATP is produced.",
                color: "#00b894",
                video: "https://assets.mixkit.co/videos/preview/mixkit-cells-under-a-microscope-15828-large.mp4"
            },
            { 
                name: "Chloroplast", 
                categories: ["Photosynthesis"], 
                description: "Where photosynthesis occurs in plant cells.",
                color: "#00cec9",
                video: "https://assets.mixkit.co/videos/preview/mixkit-cells-under-a-microscope-15828-large.mp4"
            },
            { 
                name: "Golgi Apparatus", 
                categories: ["Cell Function"], 
                description: "The post office of the cell, modifying and packaging proteins.",
                color: "#fdcb6e",
                video: "https://assets.mixkit.co/videos/preview/mixkit-cells-under-a-microscope-15828-large.mp4"
            },
            { 
                name: "Endoplasmic Reticulum", 
                categories: ["Cell Function"], 
                description: "The transportation network with rough and smooth regions.",
                color: "#e17055",
                video: "https://assets.mixkit.co/videos/preview/mixkit-cells-under-a-microscope-15828-large.mp4"
            }
        ];

        // Enemy types by category
        const enemyTypes = {
            "Cell Structure": ["Misfolded Protein", "Viral Invader", "Damaged Organelle"],
            "Cell Function": ["Toxic Metabolite", "Energy Parasite", "Dysfunctional Enzyme"],
            "Cell Types": ["Mutated Cell", "Aggressive Microbe", "Hostile Prokaryote"],
            "Photosynthesis": ["Light Blocker", "Chlorophyll Eater", "Oxygen Thief"],
            "Reproduction": ["DNA Breaker", "Mutagen", "Cell Division Disruptor"],
            "Cellular Energy": ["ATP Drainer", "Mitochondrial Virus", "Energy Vampire"]
        };

        // Game state
        let player;
        let currentEnemy = null;
        let currentQuestion = null;
        let selectedAnswer = null;

        // DOM helper functions
        function logMessage(message, screen = "main") {
            const battleLog = document.getElementById(screen === "battle" ? "battle-log-2" : "battle-log");
            if (battleLog) {
                const log = document.createElement('div');
                log.innerHTML = message;
                log.className = 'fade-in';
                battleLog.appendChild(log);
                battleLog.scrollTop = battleLog.scrollHeight;
            }
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        // Game classes
        class Player {
            constructor(name) {
                this.name = name;
                this.level = 1;
                this.hp = 100;
                this.max_hp = 100;
                this.exp = 0;
                this.exp_to_level = 100;
                this.knowledge = {
                    "Cell Structure": 1,
                    "Cell Function": 1,
                    "Cell Types": 1,
                    "Photosynthesis": 1,
                    "Reproduction": 1,
                    "Cellular Energy": 1
                };
                this.location = "Cell Membrane";
                this.questionsAnswered = 0;
                this.correctAnswers = 0;
            }

            levelUp() {
                this.level += 1;
                this.max_hp += 20;
                this.hp = this.max_hp;
                this.exp -= this.exp_to_level;
                this.exp_to_level = Math.floor(this.exp_to_level * 1.5);
                
                // Improve knowledge in random categories
                const categories = Object.keys(this.knowledge);
                const randomCategory1 = categories[Math.floor(Math.random() * categories.length)];
                const randomCategory2 = categories[Math.floor(Math.random() * categories.length)];
                this.knowledge[randomCategory1] += 1;
                this.knowledge[randomCategory2] += 1;
                
                logMessage(`<span style="color: var(--accent);">üåü ${this.name} leveled up to Level ${this.level}! üåü</span>`);
                logMessage(`Max HP increased to ${this.max_hp}!`);
                logMessage(`Your knowledge in <span style="color: var(--primary);">${randomCategory1}</span> and <span style="color: var(--primary);">${randomCategory2}</span> improved!`);
                
                // Play level up effect
                document.getElementById('heal-effect').style.opacity = '0.5';
                setTimeout(() => {
                    document.getElementById('heal-effect').style.opacity = '0';
                }, 1000);
            }

            heal(amount) {
                this.hp = Math.min(this.hp + amount, this.max_hp);
                logMessage(`<span style="color: var(--success);">‚öïÔ∏è You used a health pack! +${amount} HP. Current HP: ${this.hp}/${this.max_hp}</span>`);
                
                // Play heal effect
                document.getElementById('heal-effect').style.opacity = '0.5';
                setTimeout(() => {
                    document.getElementById('heal-effect').style.opacity = '0';
                }, 500);
            }

            takeDamage(damage) {
                this.hp -= damage;
                
                // Play damage effect
                document.getElementById('damage-effect').style.opacity = '0.5';
                setTimeout(() => {
                    document.getElementById('damage-effect').style.opacity = '0';
                }, 500);
                
                if (this.hp <= 0) {
                    logMessage(`<span style="color: var(--danger);">üíÄ ${this.name} has been defeated! üíÄ</span>`);
                    return true;
                }
                logMessage(`<span style="color: var(--danger);">‚ö†Ô∏è You took ${damage} damage! HP: ${this.hp}/${this.max_hp}</span>`);
                return false;
            }

            gainExp(amount) {
                this.exp += amount;
                logMessage(`<span style="color: var(--warning);">‚ú® You gained ${amount} EXP!</span>`);
                if (this.exp >= this.exp_to_level) {
                    this.levelUp();
                }
            }

            answerQuestion(correct) {
                this.questionsAnswered++;
                if (correct) {
                    this.correctAnswers++;
                }
            }

            getAccuracy() {
                return this.questionsAnswered > 0 
                    ? Math.round((this.correctAnswers / this.questionsAnswered) * 100)
                    : 0;
            }

            displayStats() {
                let stats = `<div style="margin-bottom: 10px;"><strong style="color: var(--primary);">${this.name}</strong> | Level ${this.level}</div>`;
                
                // HP Bar
                stats += `<div style="margin-bottom: 5px;">HP: ${this.hp}/${this.max_hp}</div>`;
                stats += `<div class="progress-container"><div class="progress-bar" style="width: ${(this.hp / this.max_hp) * 100}%;"></div></div>`;
                
                // EXP Bar
                stats += `<div style="margin-bottom: 5px;">EXP: ${this.exp}/${this.exp_to_level}</div>`;
                stats += `<div class="progress-container"><div class="progress-bar" style="width: ${(this.exp / this.exp_to_level) * 100}%; background: linear-gradient(90deg, var(--info), var(--secondary));"></div></div>`;
                
                stats += `<div style="margin: 10px 0;">Location: <strong>${this.location}</strong></div>`;
                stats += `<div style="margin-bottom: 10px;">Accuracy: <strong>${this.getAccuracy()}%</strong></div>`;
                
                // Knowledge - now clickable
                stats += `<div>Knowledge: <span style="color: var(--accent); cursor: pointer; text-decoration: underline;" onclick="showKnowledgeOverlay()">View Details</span></div>`;
                
                return stats;
            }
        }

        class Enemy {
            constructor(name, level, category) {
                this.name = name;
                this.level = level;
                this.hp = 30 + (level * 10);
                this.max_hp = this.hp;
                this.damage = 5 + (level * 2);
                this.category = category;
                this.videoUrl = this.getEnemyVideo();
            }

            getEnemyVideo() {
                // Different videos for different enemy types
                const videos = {
                    "Misfolded Protein": "https://assets.mixkit.co/videos/preview/mixkit-microscopic-view-of-a-virus-rotating-15645-large.mp4",
                    "Viral Invader": "https://assets.mixkit.co/videos/preview/mixkit-microscopic-view-of-a-virus-rotating-15645-large.mp4",
                    "Damaged Organelle": "https://assets.mixkit.co/videos/preview/mixkit-cells-under-a-microscope-15828-large.mp4",
                    "default": "https://assets.mixkit.co/videos/preview/mixkit-microscopic-view-of-a-virus-rotating-15645-large.mp4"
                };
                
                return videos[this.name] || videos.default;
            }

            getQuestion() {
                // Get a random unused question from the category
                const question = getRandomQuestion(this.category);
                return question;
            }

            takeDamage(damage) {
                this.hp -= damage;
                if (this.hp <= 0) {
                    logMessage(`<span style="color: var(--success);">üíÄ ${this.name} has been defeated! üíÄ</span>`, "battle");
                    return true;
                }
                logMessage(`<span style="color: var(--accent);">‚ö° ${this.name} took ${damage} damage! HP: ${this.hp}/${this.max_hp}</span>`, "battle");
                
                // Shake animation
                const video = document.querySelector('.enemy-video');
                if (video) {
                    video.classList.add('shake');
                    setTimeout(() => video.classList.remove('shake'), 500);
                }
                
                return false;
            }

            attack(player) {
                logMessage(`<span style="color: var(--danger);">‚ò†Ô∏è ${this.name} attacks you with a ${this.category} question!</span>`, "battle");
                return player.takeDamage(this.damage);
            }

            displayStats() {
                let stats = `<div style="margin-bottom: 10px;"><strong style="color: var(--danger);">${this.name}</strong> | Level ${this.level}</div>`;
                
                // HP Bar
                stats += `<div style="margin-bottom: 5px;">HP: ${this.hp}/${this.max_hp}</div>`;
                stats += `<div class="progress-container"><div class="progress-bar" style="width: ${(this.hp / this.max_hp) * 100}%; background: linear-gradient(90deg, var(--danger), #e17055);"></div></div>`;
                
                stats += `<div style="margin: 5px 0;">Category: <span style="color: ${this.getCategoryColor()}">${this.category}</span></div>`;
                stats += `<div>Damage: <strong>${this.damage}</strong></div>`;
                
                return stats;
            }

            getCategoryColor() {
                const colors = {
                    "Cell Structure": "#74b9ff",
                    "Cell Function": "#a29bfe",
                    "Cell Types": "#fd79a8",
                    "Photosynthesis": "#00b894",
                    "Reproduction": "#00cec9",
                    "Cellular Energy": "#fdcb6e"
                };
                return colors[this.category] || "#ffffff";
            }
        }

        // Overlay functions
        function showKnowledgeOverlay() {
            const overlay = document.getElementById('knowledge-overlay');
            const display = document.getElementById('knowledge-display');
            
            let html = '';
            for (const [category, level] of Object.entries(player.knowledge)) {
                html += `
                    <div class="knowledge-item">
                        <div>${category}</div>
                        <div class="knowledge-stars">${"‚òÖ".repeat(level)}${"‚òÜ".repeat(5-level)}</div>
                        <div>Level ${level}</div>
                    </div>
                `;
            }
            
            display.innerHTML = html;
            overlay.style.display = 'flex';
        }

        function closeOverlay() {
            document.getElementById('knowledge-overlay').style.display = 'none';
        }

        // Game functions
        function startGame() {
            const name = document.getElementById('player-name').value.trim();
            if (!name) {
                alert("Please enter your name, Doctor!");
                return;
            }
            player = new Player(name);
            logMessage(`<span style="color: var(--primary);">üî¨ Welcome, Dr. ${name}! You've been miniaturized to explore the cellular world.</span>`);
            logMessage(`<span style="color: var(--accent);">‚ö†Ô∏è Dangerous pathogens threaten the cell - use your biology knowledge to defeat them!</span>`);
            showMainMenu();
        }

        function showMainMenu() {
            const location = locations.find(loc => loc.name === player.location);
            
            document.getElementById('player-stats').innerHTML = player.displayStats();
            document.getElementById('location-title').textContent = `Current Location: ${location.name}`;
            document.getElementById('location-title').style.color = location.color;
            document.getElementById('location-description').textContent = location.description;
            
            const video = document.getElementById('location-video');
            video.querySelector('source').src = location.video;
            video.load();
            
            showScreen('main-menu-screen');
        }

        function explore() {
            const location = locations.find(loc => loc.name === player.location);
            logMessage(`<span style="color: ${location.color};">üåê Exploring the ${player.location}...</span>`);
            
            // Random events
            const event = Math.random();
            
            if (event < 0.7) { // 70% chance of encounter
                // Choose random category from location's categories
                const category = location.categories[Math.floor(Math.random() * location.categories.length)];
                
                // Enemy level based on player level and knowledge
                const baseLevel = Math.max(1, player.level + Math.floor(Math.random() * 3) - 1);
                const knowledgeModifier = Math.floor(player.knowledge[category] / 2);
                const enemyLevel = Math.max(1, baseLevel - knowledgeModifier);
                
                const enemies = enemyTypes[category];
                const enemyName = enemies[Math.floor(Math.random() * enemies.length)];
                currentEnemy = new Enemy(enemyName, enemyLevel, category);
                
                logMessage(`<span style="color: var(--danger);">‚ö†Ô∏è Pathogen Detected: ${currentEnemy.name} (Level ${currentEnemy.level})!</span>`);
                startBattle();
            } else if (event < 0.9) { // 20% chance to find health pack
                logMessage(`<span style="color: var(--success);">‚öïÔ∏è You found a health pack! +20 HP</span>`);
                player.heal(20);
            } else { // 10% chance nothing happens
                logMessage(`<span style="color: ${location.color};">üîç You carefully examine the ${player.location} but find nothing unusual.</span>`);
            }
        }

        function startBattle() {
            currentQuestion = currentEnemy.getQuestion();
            
            document.getElementById('battle-player-stats').innerHTML = player.displayStats();
            document.getElementById('enemy-stats').innerHTML = currentEnemy.displayStats();
            document.getElementById('battle-title').textContent = `BATTLE: ${currentEnemy.name}`;
            document.getElementById('question-text').textContent = currentQuestion.question;
            
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = currentQuestion.options.map((option, index) => `
                <div class="option" onclick="selectAnswer(${index})">
                    ${String.fromCharCode(65 + index)}) ${option}
                </div>
            `).join('');
            
            const video = document.getElementById('enemy-video');
            video.querySelector('source').src = currentEnemy.videoUrl;
            video.load();
            
            document.getElementById('submit-btn').disabled = true;
            showScreen('battle-screen');
        }

        function selectAnswer(index) {
            // Remove previous selection
            const options = document.querySelectorAll('.option');
            options.forEach(opt => opt.classList.remove('selected'));
            
            // Add selection to clicked option
            options[index].classList.add('selected');
            selectedAnswer = index;
            
            // Enable submit button
            document.getElementById('submit-btn').disabled = false;
        }

        function checkAnswer() {
            const correct = selectedAnswer === currentQuestion.answer;
            player.answerQuestion(correct);
            
            // Highlight correct and incorrect answers
            const options = document.querySelectorAll('.option');
            options.forEach((opt, index) => {
                if (index === currentQuestion.answer) {
                    opt.classList.add('correct');
                } else if (index === selectedAnswer && !correct) {
                    opt.classList.add('incorrect');
                }
            });
            
            // Disable all options
            options.forEach(opt => {
                opt.style.pointerEvents = 'none';
            });
            
            // Disable submit button
            document.getElementById('submit-btn').disabled = true;
            
            if (correct) {
                const knowledgeBonus = player.knowledge[currentQuestion.category] || 1;
                const damage = 10 * knowledgeBonus;
                
                logMessage(`<span style="color: var(--success);">‚úÖ Correct! Your ${currentQuestion.category} knowledge dealt ${damage} damage!</span>`, "battle");
                
                if (currentEnemy.takeDamage(damage)) {
                    const expGain = currentEnemy.level * 20;
                    player.gainExp(expGain);
                    currentEnemy = null;
                    setTimeout(showMainMenu, 2000);
                    return;
                }
            } else {
                logMessage(`<span style="color: var(--danger);">‚ùå Incorrect! The correct answer was ${String.fromCharCode(65 + currentQuestion.answer)}.</span>`, "battle");
            }
            
            // Enemy's turn if it's still alive
            if (currentEnemy && currentEnemy.hp > 0) {
                setTimeout(() => {
                    if (currentEnemy.attack(player)) {
                        gameOver();
                    } else {
                        startBattle();
                    }
                }, 2000);
            }
        }

        function tryFlee() {
            if (Math.random() < 0.5) {
                logMessage(`<span style="color: var(--info);">üèÉ‚Äç‚ôÇÔ∏è You successfully retreated from the ${currentEnemy.name}!</span>`, "battle");
                currentEnemy = null;
                showMainMenu();
            } else {
                logMessage(`<span style="color: var(--danger);">‚ö†Ô∏è Escape failed! The ${currentEnemy.name} blocks your path!</span>`, "battle");
                
                // Enemy's turn
                setTimeout(() => {
                    if (currentEnemy.attack(player)) {
                        gameOver();
                    } else {
                        startBattle();
                    }
                }, 1000);
            }
        }

        function showLocationScreen() {
            const locationCards = document.getElementById('location-cards');
            locationCards.innerHTML = locations.map(loc => `
                <div class="location-card" onclick="changeLocation('${loc.name}')">
                    <h3 style="color: ${loc.color};">${loc.name}</h3>
                    <p>${loc.description}</p>
                    <div>
                        ${loc.categories.map(cat => 
                            `<span class="location-category">${cat}</span>`
                        ).join('')}
                    </div>
                </div>
            `).join('');
            
            showScreen('location-screen');
        }

        function changeLocation(locationName) {
            player.location = locationName;
            logMessage(`<span style="color: #74b9ff;">‚úàÔ∏è You traveled to the ${locationName}.</span>`);
            showMainMenu();
        }

        function rest() {
            player.heal(20);
        }

        function gameOver() {
            const accuracy = player.getAccuracy();
            
            document.getElementById('game-over-text').textContent = `Your cellular exploration has ended, Dr. ${player.name}.`;
            document.getElementById('final-level').textContent = player.level;
            document.getElementById('questions-answered').textContent = player.questionsAnswered;
            document.getElementById('final-accuracy').textContent = `${accuracy}%`;
            
            let comment = "";
            if (accuracy > 80) {
                comment = "üèÜ Outstanding performance! Your biology expertise is remarkable!";
                document.getElementById('performance-comment').style.color = "var(--success)";
            } else if (accuracy > 60) {
                comment = "üëç Solid work! With more study, you'll master cellular biology!";
                document.getElementById('performance-comment').style.color = "var(--warning)";
            } else {
                comment = "üìö Review your biology concepts and try again!";
                document.getElementById('performance-comment').style.color = "var(--info)";
            }
            document.getElementById('performance-comment').textContent = comment;
            
            showScreen('game-over-screen');
        }

        function resetGame() {
            const name = player.name;
            player = new Player(name);
            logMessage(`<span style="color: var(--primary);">üî¨ Welcome back, Dr. ${name}! Beginning new cellular expedition...</span>`);
            showMainMenu();
        }
    </script>
</body>
</html>
